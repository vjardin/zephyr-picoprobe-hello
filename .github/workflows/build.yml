name: Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: picoprobe-hello
      - name: Pull Zephyr CI image
        run: docker pull ghcr.io/zephyrproject-rtos/ci:v0.28.7
      - name: Initialize Zephyr workspace and build
        run: |
          mkdir -p ${{ github.workspace }}/artifacts
          docker run --rm \
            -v ${{ github.workspace }}/picoprobe-hello:/workdir/picoprobe-hello \
            -v ${{ github.workspace }}/artifacts:/workdir/artifacts \
            -w /workdir \
            ghcr.io/zephyrproject-rtos/ci:v0.28.7 \
            bash -c "
              west init -l picoprobe-hello && \
              west update && \
              west zephyr-export && \
              west build -b rpi_pico picoprobe-hello && \
              cp build/zephyr/zephyr.uf2 artifacts/picoprobe-hello.uf2 && \
              cp build/zephyr/zephyr.elf artifacts/picoprobe-hello.elf
            "
      - name: Copy firmware for Wokwi
        run: |
          mkdir -p ${{ github.workspace }}/picoprobe-hello/build/zephyr
          cp ${{ github.workspace }}/artifacts/picoprobe-hello.uf2 \
             ${{ github.workspace }}/picoprobe-hello/build/zephyr/zephyr.uf2
          cp ${{ github.workspace }}/artifacts/picoprobe-hello.elf \
             ${{ github.workspace }}/picoprobe-hello/build/zephyr/zephyr.elf
      - name: Test with Wokwi
        uses: wokwi/wokwi-ci-action@v1
        continue-on-error: true
        with:
          token: ${{ secrets.WOKWI_CLI_TOKEN }}
          path: picoprobe-hello
          timeout: 10000
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: |
            ${{ github.workspace }}/artifacts/picoprobe-hello.uf2
            ${{ github.workspace }}/artifacts/picoprobe-hello.elf
